<!-- Arquivo: customer-detail-modal.component.html -->
<!-- Localização: src/app/pages/crm/components/customer-detail-modal/customer-detail-modal.component.html -->
<!-- Função: Template do modal de detalhes do cliente com DETALHES COMPLETOS DAS VENDAS -->

<div class="modal-overlay" (click)="close()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <!-- Header -->
        <div class="modal-header">
            <h2>
                <i class="eva eva-person-outline"></i>
                Detalhes do Cliente
            </h2>
            <button class="close-btn" (click)="close()">
                <i class="eva eva-close-outline"></i>
            </button>
        </div>

        <!-- Loading -->
        <div class="loading" *ngIf="loading">
            <i class="eva eva-loader-outline spinning"></i>
            <p>Carregando dados...</p>
        </div>

        <!-- Conteúdo Principal -->
        <div class="modal-body" *ngIf="!loading">
            <!-- Informações do Cliente -->
            <div class="customer-info">
                <h3>{{ customer?.customerName }}</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>ID do Cliente:</label>
                        <span class="mono">{{ customer?.customerId }}</span>
                    </div>
                    <div class="info-item">
                        <label>Email:</label>
                        <span>{{ customer?.email || 'Não informado' }}</span>
                    </div>
                    <div class="info-item">
                        <label>Telefone:</label>
                        <span>{{ customer?.phone || 'Não informado' }}</span>
                    </div>
                    <div class="info-item">
                        <label>CPF/CNPJ:</label>
                        <span>{{ customer?.cpfCnpj || 'Não informado' }}</span>
                    </div>
                    <div class="info-item">
                        <label>Total Gasto:</label>
                        <span class="value">{{ formatCurrency(customer?.totalSpent) }}</span>
                    </div>
                    <div class="info-item">
                        <label>Total de Compras:</label>
                        <span>{{ customer?.totalPurchases || allOrders.length }}</span>
                    </div>
                </div>
            </div>

            <!-- Resumo por Coleção -->
            <div class="orders-summary">
                <h3>📊 Resumo de Vendas</h3>
                <div class="collection-cards">
                    <div class="collection-card" *ngFor="let collection of ordersByCollection">
                        <div class="collection-header">
                            <i [class]="getCollectionIcon(collection.name)"></i>
                            <span>{{ getCollectionLabel(collection.name) }}</span>
                            <span class="badge">{{ collection.orders.length }}</span>
                        </div>
                        <div class="collection-stats">
                            <p><strong>Total:</strong> {{ formatCurrency(collection.total) }}</p>
                            <p><strong>Primeira:</strong> {{ formatDate(collection.firstDate) }}</p>
                            <p><strong>Última:</strong> {{ formatDate(collection.lastDate) }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detalhes das Vendas (NOVO - EXPANDIDO) -->
            <div class="orders-details">
                <h3>🛒 Histórico Detalhado de Vendas</h3>

                <!-- Filtros -->
                <div class="filters-section">
                    <select [(ngModel)]="selectedCollection" (change)="filterOrders()">
                        <option value="">Todas as Coleções</option>
                        <option *ngFor="let coll of ordersByCollection" [value]="coll.name">
                            {{ getCollectionLabel(coll.name) }} ({{ coll.orders.length }})
                        </option>
                    </select>

                    <input type="text" placeholder="Buscar produto, código..." [(ngModel)]="searchTerm"
                        (input)="filterOrders()">
                </div>

                <!-- Lista de Vendas Detalhadas -->
                <div class="orders-list">
                    <div class="order-item" *ngFor="let order of filteredOrders; let i = index">
                        <!-- Cabeçalho da Venda -->
                        <div class="order-header" (click)="toggleOrderDetails(i)">
                            <div class="order-info">
                                <span class="order-number">#{{ order.code || order._docId?.substring(0, 8) }}</span>
                                <span class="order-date">{{ formatDate(order.date) }}</span>
                                <span class="order-collection">{{ getCollectionLabel(order._collection) }}</span>
                            </div>
                            <div class="order-value">
                                {{ formatCurrency(order.value) }}
                                <i class="eva" [class.eva-chevron-down-outline]="!order.showDetails"
                                    [class.eva-chevron-up-outline]="order.showDetails"></i>
                            </div>
                        </div>

                        <!-- Detalhes Expandidos da Venda -->
                        <div class="order-details" *ngIf="order.showDetails">
                            <!-- Informações do Cliente na Venda -->
                            <div class="detail-section">
                                <h4>👤 Cliente na Venda</h4>
                                <div class="detail-grid">
                                    <div>
                                        <label>ID:</label>
                                        <span class="mono">{{ order.customerInOrder?._id || 'N/A' }}</span>
                                    </div>
                                    <div>
                                        <label>Nome:</label>
                                        <span>{{ order.customerInOrder?.name || 'N/A' }}</span>
                                    </div>
                                    <div>
                                        <label>Código:</label>
                                        <span>{{ order.customerInOrder?.code || 'N/A' }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Produtos da Venda -->
                            <div class="detail-section" *ngIf="order.products && order.products.length > 0">
                                <h4>📦 Produtos</h4>
                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Qtd</th>
                                            <th>Valor Unit.</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let product of order.products">
                                            <td>{{ product.name || product.description }}</td>
                                            <td>{{ product.quantity || 1 }}</td>
                                            <td>{{ formatCurrency(product.unitPrice || product.price) }}</td>
                                            <td>{{ formatCurrency(product.total || (product.quantity * product.price))
                                                }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Serviços da Venda -->
                            <div class="detail-section" *ngIf="order.services && order.services.length > 0">
                                <h4>🔧 Serviços</h4>
                                <table class="services-table">
                                    <thead>
                                        <tr>
                                            <th>Serviço</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let service of order.services">
                                            <td>{{ service.name || service.description }}</td>
                                            <td>{{ formatCurrency(service.value || service.price) }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagamentos -->
                            <div class="detail-section" *ngIf="order.paymentMethods && order.paymentMethods.length > 0">
                                <h4>💳 Formas de Pagamento</h4>
                                <div class="payment-list">
                                    <div class="payment-item" *ngFor="let payment of order.paymentMethods">
                                        <span>{{ payment.name || payment.method }}</span>
                                        <span>{{ formatCurrency(payment.value || payment.amount) }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Informações Adicionais -->
                            <div class="detail-section">
                                <h4>ℹ️ Informações Adicionais</h4>
                                <div class="detail-grid">
                                    <div *ngIf="order.discount">
                                        <label>Desconto:</label>
                                        <span>{{ formatCurrency(order.discount) }}</span>
                                    </div>
                                    <div *ngIf="order.fee">
                                        <label>Taxa:</label>
                                        <span>{{ formatCurrency(order.fee) }}</span>
                                    </div>
                                    <div *ngIf="order.status">
                                        <label>Status:</label>
                                        <span>{{ order.status }}</span>
                                    </div>
                                    <div *ngIf="order.collaborator">
                                        <label>Vendedor:</label>
                                        <span>{{ order.collaborator.name || order.collaborator }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Debug - Dados Brutos -->
                            <div class="detail-section" *ngIf="showDebugInfo">
                                <h4>🐛 Debug - Estrutura da Venda</h4>
                                <pre class="debug-info">{{ getOrderDebugInfo(order) }}</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensagem quando não há vendas -->
                <div class="no-orders" *ngIf="filteredOrders.length === 0">
                    <i class="eva eva-inbox-outline"></i>
                    <p>Nenhuma venda encontrada com os filtros aplicados.</p>
                </div>
            </div>

            <!-- Análise de Problemas -->
            <div class="analysis-section">
                <h3>🔍 Análise de Problemas</h3>

                <div class="problem-card" *ngIf="analysisResults.multipleIds">
                    <h5>⚠️ Múltiplos IDs Encontrados</h5>
                    <p>Este cliente possui {{ analysisResults.uniqueIds.length }} IDs diferentes nas vendas:</p>
                    <ul>
                        <li *ngFor="let id of analysisResults.uniqueIds" class="mono">{{ id }}</li>
                    </ul>
                </div>

                <div class="problem-card" *ngIf="analysisResults.multipleCodes">
                    <h5>⚠️ Múltiplos Códigos Encontrados</h5>
                    <p>Este cliente possui {{ analysisResults.uniqueCodes.length }} códigos diferentes nas vendas:</p>
                    <ul>
                        <li *ngFor="let code of analysisResults.uniqueCodes">Código: {{ code }}</li>
                    </ul>
                </div>

                <div class="problem-card success" *ngIf="!analysisResults.hasProblems">
                    <h5>✅ Nenhum Problema Detectado</h5>
                    <p>Os dados deste cliente parecem estar consistentes em todas as vendas.</p>
                </div>

                <!-- Botões de Debug -->
                <div class="debug-buttons">
                    <button class="btn btn-secondary" (click)="showRawData = !showRawData">
                        {{ showRawData ? 'Ocultar' : 'Mostrar' }} Dados Brutos (JSON)
                    </button>
                    <button class="btn btn-secondary" (click)="showDebugInfo = !showDebugInfo">
                        {{ showDebugInfo ? 'Ocultar' : 'Mostrar' }} Info de Debug
                    </button>
                </div>

                <pre *ngIf="showRawData" class="raw-data">{{ getRawDataJson() }}</pre>
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
            <button class="btn btn-secondary" (click)="close()">Fechar</button>
            <button class="btn btn-primary" (click)="exportData()">
                <i class="eva eva-download-outline"></i>
                Exportar Dados
            </button>
        </div>
    </div>
</div>
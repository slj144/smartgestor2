<!-- Arquivo: customer-import.component.html -->
<!-- Localização: src/app/pages/crm/components/customer-import/customer-import.component.html -->
<!-- VERSÃO COMPLETA com botão de detalhes já integrado -->

<div class="customer-import-container">
    <!-- Header -->
    <div class="import-header">
        <h2>
            <i class="eva eva-people-outline"></i>
            Importação Inteligente de Clientes
        </h2>
        <button class="close-btn" (click)="close()">
            <i class="eva eva-close-outline"></i>
        </button>
    </div>

    <!-- Step: Início -->
    <div class="import-content" *ngIf="currentStep === 'start'">
        <div class="welcome-section">
            <div class="welcome-icon">
                <i class="eva eva-trending-up-outline"></i>
            </div>
            <h3>Análise Inteligente de Clientes</h3>
            <p>
                Vamos analisar seu histórico de vendas e identificar os melhores clientes
                para campanhas de marketing e reativação.
            </p>

            <div class="features-grid">
                <div class="feature-card">
                    <i class="eva eva-bar-chart-outline"></i>
                    <h4>Análise RFM</h4>
                    <p>Recência, Frequência e Valor Monetário</p>
                </div>
                <div class="feature-card">
                    <i class="eva eva-funnel-outline"></i>
                    <h4>Categorização</h4>
                    <p>Hot, Warm, Cold e Novos clientes</p>
                </div>
                <div class="feature-card">
                    <i class="eva eva-bulb-outline"></i>
                    <h4>Recomendações</h4>
                    <p>Ações personalizadas por perfil</p>
                </div>
            </div>

            <button class="btn btn-primary btn-large" (click)="startAnalysis()">
                <i class="eva eva-search-outline"></i>
                Iniciar Análise
            </button>
        </div>
    </div>

    <!-- Step: Analisando -->
    <div class="import-content" *ngIf="currentStep === 'analyzing'">
        <div class="analyzing-section">
            <div class="progress-animation">
                <div class="spinner">
                    <i class="eva eva-loader-outline"></i>
                </div>
            </div>

            <h3>{{ importProgress.message }}</h3>

            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="(importProgress.current / importProgress.total) * 100">
                </div>
            </div>

            <div class="progress-info">
                <span>{{ importProgress.current }} de {{ importProgress.total }}</span>
                <span>{{ ((importProgress.current / importProgress.total) * 100).toFixed(0) }}%</span>
            </div>
        </div>
    </div>

    <!-- Step: Seleção -->
    <div class="import-content" *ngIf="currentStep === 'selection'">
        <!-- Estatísticas -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon hot">
                    <i class="eva eva-fire-outline"></i>
                </div>
                <div class="stat-info">
                    <h4>{{ stats.hotCustomers }}</h4>
                    <p>Clientes Hot</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warm">
                    <i class="eva eva-sun-outline"></i>
                </div>
                <div class="stat-info">
                    <h4>{{ stats.warmCustomers }}</h4>
                    <p>Clientes Warm</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon cold">
                    <i class="eva eva-snowflake-outline"></i>
                </div>
                <div class="stat-info">
                    <h4>{{ stats.coldCustomers }}</h4>
                    <p>Clientes Cold</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon new">
                    <i class="eva eva-person-add-outline"></i>
                </div>
                <div class="stat-info">
                    <h4>{{ stats.newCustomers }}</h4>
                    <p>Novos Clientes</p>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="filter-group">
                <label>Categoria:</label>
                <select [(ngModel)]="filterCategory" (change)="applyFilters()">
                    <option value="all">Todas</option>
                    <option value="hot">Hot</option>
                    <option value="warm">Warm</option>
                    <option value="cold">Cold</option>
                    <option value="new">Novos</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Prioridade:</label>
                <select [(ngModel)]="filterPriority" (change)="applyFilters()">
                    <option value="all">Todas</option>
                    <option value="high">Alta</option>
                    <option value="medium">Média</option>
                    <option value="low">Baixa</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Buscar:</label>
                <input type="text" [(ngModel)]="searchTerm" (input)="applyFilters()" placeholder="Nome ou email...">
            </div>
            <div class="filter-group">
                <label>
                    <input type="checkbox" [(ngModel)]="showOnlyNew" (change)="applyFilters()">
                    Apenas novos leads
                </label>
            </div>
        </div>

        <!-- Tabela de Resultados -->
        <div class="results-section">
            <div class="results-header">
                <h3>
                    {{ getFilteredResults().length }} clientes encontrados
                    <span *ngIf="selectedCustomers.size > 0">
                        ({{ selectedCustomers.size }} selecionados)
                    </span>
                </h3>
                <div class="bulk-actions">
                    <button class="btn btn-secondary" (click)="selectAllVisible()"
                        [disabled]="getFilteredResults().length === 0">
                        Selecionar Visíveis
                    </button>
                    <button class="btn btn-secondary" (click)="clearSelection()"
                        [disabled]="selectedCustomers.size === 0">
                        Limpar Seleção
                    </button>
                </div>
            </div>

            <div class="results-table">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll()">
                            </th>
                            <th>Cliente</th>
                            <th>Categoria</th>
                            <th>Total Gasto</th>
                            <th>Compras</th>
                            <th>Última Compra</th>
                            <th>Score</th>
                            <th>Ações</th> <!-- BOTÃO ADICIONADO AQUI -->
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let analysis of getFilteredResults()">
                            <td>
                                <input type="checkbox" [checked]="selectedCustomers.has(analysis.customerId)"
                                    (change)="toggleCustomerSelection(analysis.customerId)">
                            </td>
                            <td>
                                <div class="customer-info">
                                    <div class="customer-name">{{ analysis.customerName }}</div>
                                    <div class="customer-email">{{ analysis.email || 'Sem email' }}</div>
                                </div>
                            </td>
                            <td>
                                <span class="category-badge" [attr.data-category]="analysis.category">
                                    {{ getCategoryLabel(analysis.category) }}
                                </span>
                            </td>
                            <td class="text-right">{{ formatCurrency(analysis.totalSpent) }}</td>
                            <td class="text-center">{{ analysis.totalPurchases }}</td>
                            <td>{{ formatDate(analysis.lastPurchaseDate) }}</td>
                            <td>
                                <div class="score-container">
                                    <div class="score-bar">
                                        <div class="score-fill" [style.width.%]="analysis.score"></div>
                                    </div>
                                    <span class="score-text">{{ analysis.score }}</span>
                                </div>
                            </td>
                            <td class="actions-cell">
                                <!-- CÉLULA COM O BOTÃO -->
                                <button class="action-btn view-btn" (click)="viewCustomerDetails(analysis)"
                                    title="Ver detalhes completos do cliente">
                                    <i class="eva eva-eye-outline"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="empty-state" *ngIf="getFilteredResults().length === 0">
                    <i class="eva eva-search-outline"></i>
                    <p>Nenhum cliente encontrado com os filtros aplicados</p>
                </div>
            </div>
        </div>

        <!-- Ações -->
        <div class="actions-footer">
            <button class="btn btn-secondary" (click)="currentStep = 'start'">
                <i class="eva eva-arrow-back-outline"></i>
                Voltar
            </button>
            <button class="btn btn-primary" (click)="importSelected()" [disabled]="selectedCustomers.size === 0">
                <i class="eva eva-checkmark-outline"></i>
                Importar {{ selectedCustomers.size }} Selecionados
            </button>
        </div>
    </div>

    <!-- Step: Importando -->
    <div class="import-content" *ngIf="currentStep === 'importing'">
        <div class="importing-section">
            <div class="progress-animation">
                <div class="spinner">
                    <i class="eva eva-sync-outline"></i>
                </div>
            </div>

            <h3>{{ importProgress.message }}</h3>

            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="(importProgress.current / importProgress.total) * 100">
                </div>
            </div>

            <div class="progress-info">
                <span>{{ importProgress.current }} de {{ importProgress.total }}</span>
                <span>{{ ((importProgress.current / importProgress.total) * 100).toFixed(0) }}%</span>
            </div>
        </div>
    </div>

    <!-- Step: Completo -->
    <div class="import-content" *ngIf="currentStep === 'complete'">
        <div class="complete-section">
            <div class="success-icon">
                <i class="eva eva-checkmark-circle-outline"></i>
            </div>
            <h3>Importação Concluída!</h3>
            <p>{{ importProgress.message }}</p>

            <div class="summary-stats">
                <div class="summary-item">
                    <i class="eva eva-people-outline"></i>
                    <span>{{ importProgress.current }} clientes importados</span>
                </div>
            </div>

            <button class="btn btn-primary" (click)="close()">
                <i class="eva eva-checkmark-outline"></i>
                Concluir
            </button>
        </div>
    </div>
</div>

<!-- Modal de Detalhes do Cliente -->
<app-customer-detail-modal *ngIf="selectedCustomerForDetails" [customer]="selectedCustomerForDetails"
    [rawCustomerData]="selectedCustomerRawData" (onClose)="closeCustomerDetails()">
</app-customer-detail-modal>
<!-- 
üìÑ ARQUIVO: activities.component.html 
üìÅ LOCALIZA√á√ÉO: src/app/pages/crm/activities/activities.component.html
üéØ OBJETIVO: Template CORRIGIDO com modal limpo e templates de WhatsApp conectados
-->

<div class="activities-container">
    <!-- ‚úÖ CABE√áALHO MELHORADO - bot√µes sempre vis√≠veis -->
    <div class="page-header">
        <div class="header-content">
            <h2>
                <icon name="calendar-outline" pack="eva"></icon>
                Atividades e Tarefas
            </h2>
            <p>{{ filteredActivities.length }} atividades encontradas</p>
        </div>

        <!-- ‚úÖ BOT√ïES PRINCIPAIS - sempre vis√≠veis e bem posicionados -->
        <div class="header-actions">
            <!-- Bot√£o de alternar visualiza√ß√£o -->
            <button class="btn btn-outline" (click)="toggleView()"
                [tooltip]="calendarView ? 'Visualiza√ß√£o em Lista' : 'Visualiza√ß√£o em Calend√°rio'" [disabled]="loading">
                <icon [name]="calendarView ? 'list-outline' : 'calendar-outline'" pack="eva"></icon>
                <span class="btn-text">{{ calendarView ? 'Lista' : 'Calend√°rio' }}</span>
            </button>

            <!-- Bot√£o principal de criar atividade -->
            <button class="btn btn-primary" (click)="openCreateModal()" [disabled]="loading">
                <icon name="plus-outline" pack="eva"></icon>
                <span class="btn-text">Nova Atividade</span>
            </button>
        </div>
    </div>

    <!-- ‚úÖ SE√á√ÉO DE FILTROS MELHORADA -->
    <div class="filters-section" *ngIf="!loading">
        <!-- Barra superior com busca e bot√£o limpar -->
        <div class="filters-header">
            <!-- Campo de busca -->
            <div class="search-box">
                <icon name="search-outline" pack="eva"></icon>
                <input type="text" class="form-control search-input"
                    placeholder="Buscar por t√≠tulo, descri√ß√£o, cliente, telefone..." [(ngModel)]="filters.searchText"
                    (ngModelChange)="applyFilters()">
            </div>

            <!-- Contador e bot√£o limpar -->
            <div class="filters-actions">
                <span class="filter-count" *ngIf="activeFiltersCount > 0">
                    <icon name="funnel-outline" pack="eva"></icon>
                    {{ activeFiltersCount }} filtro{{ activeFiltersCount > 1 ? 's' : '' }} ativo{{ activeFiltersCount >
                    1 ? 's' : '' }}
                </span>
                <button class="btn btn-sm btn-outline-danger" *ngIf="activeFiltersCount > 0"
                    (click)="clearAllFilters()">
                    <icon name="close-outline" pack="eva"></icon>
                    Limpar Filtros
                </button>
            </div>
        </div>

        <!-- Grade de filtros -->
        <div class="filters-grid">
            <!-- Filtro por tipo -->
            <div class="filter-group">
                <label>
                    <icon name="layers-outline" pack="eva"></icon>
                    Tipo de Atividade
                </label>
                <select class="form-control" [(ngModel)]="filters.type" (ngModelChange)="applyFilters()">
                    <option value="all">Todos os Tipos</option>
                    <option *ngFor="let type of typeOptions" [value]="type.value">
                        {{ type.label }}
                    </option>
                </select>
            </div>

            <!-- Filtro por status -->
            <div class="filter-group">
                <label>
                    <icon name="activity-outline" pack="eva"></icon>
                    Status
                </label>
                <select class="form-control" [(ngModel)]="filters.status" (ngModelChange)="applyFilters()">
                    <option value="all">Todos os Status</option>
                    <option *ngFor="let status of statusOptions" [value]="status.value">
                        {{ status.label }}
                    </option>
                </select>
            </div>

            <!-- NOVO: Filtro por prioridade -->
            <div class="filter-group">
                <label>
                    <icon name="flag-outline" pack="eva"></icon>
                    Prioridade
                </label>
                <select class="form-control" [(ngModel)]="filters.priority" (ngModelChange)="applyFilters()">
                    <option value="all">Todas as Prioridades</option>
                    <option *ngFor="let priority of priorityOptions" [value]="priority.value">
                        {{ priority.label }}
                    </option>
                </select>
            </div>

            <!-- Filtro por data -->
            <div class="filter-group">
                <label>
                    <icon name="calendar-outline" pack="eva"></icon>
                    Per√≠odo
                </label>
                <select class="form-control" [(ngModel)]="filters.dateFilter" (ngModelChange)="applyFilters()">
                    <option value="all">Todas as Datas</option>
                    <option value="today">Hoje</option>
                    <option value="week">Esta Semana</option>
                    <option value="month">Este M√™s</option>
                    <option value="overdue">Atrasadas</option>
                    <option value="custom">Per√≠odo Customizado</option>
                </select>
            </div>

            <!-- NOVO: Datas customizadas (s√≥ aparece se selecionar "Per√≠odo Customizado") -->
            <div class="filter-group date-range" *ngIf="filters.dateFilter === 'custom'">
                <label>Data Inicial</label>
                <input type="date" class="form-control" [(ngModel)]="filters.startDate"
                    (ngModelChange)="applyFilters()">
            </div>

            <div class="filter-group date-range" *ngIf="filters.dateFilter === 'custom'">
                <label>Data Final</label>
                <input type="date" class="form-control" [(ngModel)]="filters.endDate" (ngModelChange)="applyFilters()">
            </div>

            <!-- Filtro por lead -->
            <div class="filter-group">
                <label>
                    <icon name="person-outline" pack="eva"></icon>
                    Cliente/Lead
                </label>
                <select class="form-control" [(ngModel)]="filters.leadId" (ngModelChange)="applyFilters()">
                    <option value="">Todos os Clientes</option>
                    <option *ngFor="let lead of leads" [value]="lead._id">
                        {{ lead.name }}
                    </option>
                </select>
            </div>

            <!-- NOVO: Filtro por respons√°vel -->
            <div class="filter-group" *ngIf="assignedToOptions.length > 0">
                <label>
                    <icon name="people-outline" pack="eva"></icon>
                    Respons√°vel
                </label>
                <select class="form-control" [(ngModel)]="filters.assignedTo" (ngModelChange)="applyFilters()">
                    <option value="all">Todos os Respons√°veis</option>
                    <option *ngFor="let user of assignedToOptions" [value]="user.id">
                        {{ user.name }}
                    </option>
                </select>
            </div>
        </div>
    </div>

    <!-- ‚úÖ RESUMO R√ÅPIDO -->
    <div class="summary-cards" *ngIf="!loading">
        <div class="summary-card pending">
            <div class="card-icon">
                <icon name="clock-outline" pack="eva"></icon>
            </div>
            <div class="card-content">
                <h3>{{ getActivityCount('pending') }}</h3>
                <p>Pendentes</p>
            </div>
        </div>

        <div class="summary-card overdue">
            <div class="card-icon">
                <icon name="alert-triangle-outline" pack="eva"></icon>
            </div>
            <div class="card-content">
                <h3>{{ getActivityCount('overdue') }}</h3>
                <p>Atrasadas</p>
            </div>
        </div>

        <div class="summary-card completed">
            <div class="card-icon">
                <icon name="checkmark-circle-outline" pack="eva"></icon>
            </div>
            <div class="card-content">
                <h3>{{ getActivityCount('completed') }}</h3>
                <p>Conclu√≠das</p>
            </div>
        </div>

        <div class="summary-card today">
            <div class="card-icon">
                <icon name="calendar-outline" pack="eva"></icon>
            </div>
            <div class="card-content">
                <h3>{{ getTodayCount() }}</h3>
                <p>Para Hoje</p>
            </div>
        </div>
    </div>

    <!-- ‚úÖ LOADING STATE -->
    <div class="loading-state" *ngIf="loading">
        <div class="loading-spinner">
            <icon name="loader-outline" pack="eva"></icon>
        </div>
        <p>Carregando atividades...</p>
    </div>

    <!-- ‚úÖ CONTE√öDO PRINCIPAL -->
    <div class="activities-content" *ngIf="!loading">

        <!-- VISUALIZA√á√ÉO EM LISTA -->
        <div class="activities-list" *ngIf="!calendarView">

            <!-- Mensagem quando n√£o h√° atividades -->
            <div class="empty-state" *ngIf="filteredActivities.length === 0">
                <icon name="calendar-outline" pack="eva"></icon>
                <h3>Nenhuma atividade encontrada</h3>
                <p>Crie sua primeira atividade para come√ßar a organizar suas tarefas</p>
                <button class="btn btn-primary" (click)="openCreateModal()">
                    <icon name="plus-outline" pack="eva"></icon>
                    Criar Atividade
                </button>
            </div>

            <!-- Lista de atividades -->
            <div class="activity-card" *ngFor="let activity of filteredActivities; trackBy: trackByActivity"
                [class]="'status-' + activity.status">

                <!-- ‚úÖ CABE√áALHO DA ATIVIDADE -->
                <div class="activity-header">
                    <div class="activity-info">
                        <!-- Tipo da atividade com √≠cone -->
                        <div class="activity-type" [class]="'type-' + activity.type">
                            <icon [name]="getTypeIcon(activity.type)" pack="eva"></icon>
                            <span>{{ getTypeLabel(activity.type) }}</span>
                        </div>

                        <!-- T√≠tulo -->
                        <h4 class="activity-title">{{ activity.title }}</h4>

                        <!-- Nome do lead/cliente -->
                        <p class="activity-lead" *ngIf="activity.leadName">
                            <icon name="person-outline" pack="eva"></icon>
                            {{ activity.leadName }}
                        </p>
                    </div>

                    <!-- Status e prioridade -->
                    <div class="activity-meta">
                        <span class="activity-status" [class]="'status-' + activity.status">
                            {{ getStatusLabel(activity.status) }}
                        </span>
                        <span class="activity-priority" [class]="'priority-' + activity.priority">
                            {{ getPriorityLabel(activity.priority) }}
                        </span>
                    </div>
                </div>

                <!-- ‚úÖ DESCRI√á√ÉO -->
                <div class="activity-description" *ngIf="activity.description">
                    <p>{{ activity.description }}</p>
                </div>

                <!-- ‚úÖ AGENDAMENTO -->
                <div class="activity-schedule">
                    <div class="schedule-info">
                        <icon name="calendar-outline" pack="eva"></icon>
                        <span>{{ formatDate(activity.scheduledDate) }}</span>
                        <span *ngIf="activity.scheduledTime" class="schedule-time">
                            {{ activity.scheduledTime }}
                        </span>
                    </div>
                </div>

                <!-- ‚úÖ A√á√ïES - bot√µes sempre vis√≠veis com WhatsApp conectado aos templates -->
                <div class="activity-actions">
                    <!-- ‚úÖ WHATSAPP COM TEMPLATES - a√ß√£o principal -->
                    <button class="btn btn-whatsapp" *ngIf="activity.leadPhone"
                        (click)="openWhatsAppTemplates(activity)" tooltip="Enviar WhatsApp com Templates">
                        <icon name="message-circle-outline" pack="eva"></icon>
                        <span class="action-text">WhatsApp</span>
                    </button>

                    <!-- Liga√ß√£o -->
                    <button class="btn btn-primary" *ngIf="activity.leadPhone" (click)="makeCall(activity)"
                        tooltip="Fazer Liga√ß√£o">
                        <icon name="phone-outline" pack="eva"></icon>
                        <span class="action-text">Ligar</span>
                    </button>

                    <!-- Email -->
                    <button class="btn btn-info" *ngIf="activity.leadEmail" (click)="sendEmail(activity)"
                        tooltip="Enviar Email">
                        <icon name="email-outline" pack="eva"></icon>
                        <span class="action-text">Email</span>
                    </button>

                    <!-- Marcar como conclu√≠da -->
                    <button class="btn btn-success" *ngIf="activity.status === 'pending'"
                        (click)="markAsCompleted(activity)" tooltip="Marcar como Conclu√≠da">
                        <icon name="checkmark-outline" pack="eva"></icon>
                        <span class="action-text">Concluir</span>
                    </button>

                    <!-- Editar -->
                    <button class="btn btn-outline" (click)="editActivity(activity)" tooltip="Editar Atividade">
                        <icon name="edit-outline" pack="eva"></icon>
                        <span class="action-text">Editar</span>
                    </button>

                    <!-- Excluir -->
                    <button class="btn btn-danger" (click)="deleteActivity(activity)" tooltip="Excluir Atividade">
                        <icon name="trash-outline" pack="eva"></icon>
                        <span class="action-text">Excluir</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- üÜï VISUALIZA√á√ÉO EM CALEND√ÅRIO MELHORADA -->
        <div class="calendar-view" *ngIf="calendarView">
            <!-- Cabe√ßalho do calend√°rio -->
            <div class="calendar-header">
                <!-- Navega√ß√£o -->
                <button class="btn-nav" (click)="previousMonth()">
                    <icon name="chevron-left" pack="eva"></icon>
                </button>

                <div class="month-year">
                    <h3>{{ monthNames[currentMonth.getMonth()] }} {{ currentMonth.getFullYear() }}</h3>
                    <button class="btn-today" (click)="goToToday()">Hoje</button>
                </div>

                <button class="btn-nav" (click)="nextMonth()">
                    <icon name="chevron-right" pack="eva"></icon>
                </button>
            </div>

            <!-- Dias da semana -->
            <div class="weekdays">
                <div class="weekday" *ngFor="let day of weekDays">
                    {{ day }}
                </div>
            </div>

            <!-- Grid do calend√°rio - TODOS OS DIAS CLIC√ÅVEIS -->
            <div class="calendar-grid">
                <div class="calendar-day" *ngFor="let day of calendarDays" [class.other-month]="day.isOtherMonth"
                    [class.today]="day.isToday" [class.has-activities]="day.hasActivities"
                    [class.clickable]="!day.isOtherMonth" (click)="!day.isOtherMonth ? showDayActivities(day) : null">

                    <!-- N√∫mero do dia -->
                    <div class="day-header" *ngIf="!day.isOtherMonth">
                        <span class="day-number">{{ day.day }}</span>
                        <span class="activity-count" *ngIf="day.activities.length > 0">
                            {{ day.activities.length }}
                        </span>
                    </div>

                    <!-- Preview das atividades (m√°ximo 3) -->
                    <div class="day-activities" *ngIf="!day.isOtherMonth && day.activities.length > 0">
                        <div class="activity-preview" *ngFor="let activity of day.activities.slice(0, 3)"
                            [class]="'status-' + activity.status" [tooltip]="activity.title">
                            <span class="activity-time">{{ getTimeFromDate(activity.scheduledDate) }}</span>
                            <span class="activity-title">{{ activity.title }}</span>
                        </div>

                        <!-- Indicador de mais atividades -->
                        <div class="more-activities" *ngIf="day.activities.length > 3">
                            +{{ day.activities.length - 3 }} mais
                        </div>
                    </div>

                    <!-- Indicador visual para adicionar atividade (aparece no hover) -->
                    <div class="add-activity-hint" *ngIf="!day.isOtherMonth">
                        <icon name="plus-circle-outline" pack="eva"></icon>
                    </div>
                </div>
            </div>
            <!-- Legenda -->
            <div class="calendar-legend">
                <div class="legend-item">
                    <span class="legend-dot status-pending"></span>
                    <span>Pendente</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot status-completed"></span>
                    <span>Conclu√≠da</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot status-overdue"></span>
                    <span>Atrasada</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ MODAL DE CRIA√á√ÉO/EDI√á√ÉO - Z-INDEX CORRIGIDO -->
<div class="activities-modal" *ngIf="showModal && !showTemplatesModal" [class.show]="showModal">

    <!-- Backdrop do modal de atividades -->
    <div class="modal-backdrop-activities" (click)="closeModal()"></div>

    <div class="modal-dialog-activities">
        <div class="modal-content-activities">
            <!-- Cabe√ßalho do modal -->
            <div class="modal-header-activities">
                <h5 class="modal-title">
                    <icon [name]="modalMode === 'create' ? 'plus-outline' : 'edit-outline'" pack="eva"></icon>
                    {{ modalMode === 'create' ? 'Nova Atividade' : 'Editar Atividade' }}
                </h5>
                <button type="button" class="btn-close-activities" (click)="closeModal()">
                    <icon name="close-outline" pack="eva"></icon>
                </button>
            </div>

            <!-- Corpo do modal -->
            <div class="modal-body-activities">
                <form (ngSubmit)="saveActivity()" #activityFormRef="ngForm">

                    <!-- T√≠tulo -->
                    <div class="form-group">
                        <label for="title">T√≠tulo *</label>
                        <input type="text" id="title" class="form-control" [(ngModel)]="activityForm.title" name="title"
                            placeholder="Digite o t√≠tulo da atividade" required>
                    </div>

                    <!-- Linha 1: Tipo e Lead -->
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="type">Tipo *</label>
                            <select id="type" class="form-control" [(ngModel)]="activityForm.type" name="type" required>
                                <option *ngFor="let type of typeOptions" [value]="type.value">
                                    {{ type.label }}
                                </option>
                            </select>
                        </div>

                        <div class="form-group col-md-6">
                            <label for="leadId">Lead/Cliente</label>
                            <select id="leadId" class="form-control" [(ngModel)]="activityForm.leadId" name="leadId">
                                <option value="">Selecione um lead</option>
                                <option *ngFor="let lead of leads" [value]="lead._id">
                                    {{ lead.name }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- Descri√ß√£o -->
                    <div class="form-group">
                        <label for="description">Descri√ß√£o</label>
                        <textarea id="description" class="form-control" [(ngModel)]="activityForm.description"
                            name="description" rows="3" placeholder="Descreva os detalhes da atividade"></textarea>
                    </div>

                    <!-- Linha 2: Data e Hora -->
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="scheduledDate">Data *</label>
                            <input type="date" id="scheduledDate" class="form-control"
                                [(ngModel)]="activityForm.scheduledDate" name="scheduledDate" required>
                        </div>

                        <div class="form-group col-md-6">
                            <label for="scheduledTime">Hor√°rio</label>
                            <input type="time" id="scheduledTime" class="form-control"
                                [(ngModel)]="activityForm.scheduledTime" name="scheduledTime">
                        </div>
                    </div>

                    <!-- Linha 3: Prioridade e Status -->
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="priority">Prioridade</label>
                            <select id="priority" class="form-control" [(ngModel)]="activityForm.priority"
                                name="priority">
                                <option *ngFor="let priority of priorityOptions" [value]="priority.value">
                                    {{ priority.label }}
                                </option>
                            </select>
                        </div>

                        <div class="form-group col-md-6" *ngIf="modalMode === 'edit'">
                            <label for="status">Status</label>
                            <select id="status" class="form-control" [(ngModel)]="activityForm.status" name="status">
                                <option *ngFor="let status of statusOptions" [value]="status.value">
                                    {{ status.label }}
                                </option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Rodap√© do modal com bot√µes -->
            <div class="modal-footer-activities">
                <button type="button" class="btn btn-secondary" (click)="closeModal()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" (click)="saveActivity()"
                    [disabled]="!activityForm.title || !activityForm.type || !activityForm.scheduledDate">
                    <icon name="save-outline" pack="eva"></icon>
                    {{ modalMode === 'create' ? 'Criar Atividade' : 'Salvar Altera√ß√µes' }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ MODAL DE TEMPLATES DO WHATSAPP - Z-INDEX MAIS ALTO -->
<app-message-templates *ngIf="showTemplatesModal" [customer]="selectedCustomerForTemplate"
    [showModal]="showTemplatesModal" [filterCategory]="getTemplateCategory()" (onClose)="closeTemplatesModal()"
    (onSelect)="onTemplateSelected($event)">
</app-message-templates>

<!-- üÜï MODAL DE ATIVIDADES DO DIA - VERS√ÉO FINAL CORRIGIDA -->
<div class="day-modal" *ngIf="showDayModal" [class.show]="showDayModal">
    <div class="modal-backdrop" (click)="closeDayModal()"></div>

    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Cabe√ßalho do modal -->
            <div class="modal-header">
                <h3>
                    <icon name="calendar-outline" pack="eva"></icon>
                    Atividades do dia {{ selectedDay?.day }} de {{ monthNames[currentMonth.getMonth()] }}
                </h3>
                <button class="btn-close" (click)="closeDayModal()">
                    <icon name="close-outline" pack="eva"></icon>
                </button>
            </div>

            <!-- Corpo do modal COM SCROLL -->
            <div class="modal-body">
                <div class="activities-scroll-container">
                    <!-- Lista de atividades do dia -->
                    <ng-container *ngIf="selectedDay && selectedDay.activities && selectedDay.activities.length > 0">
                        <div class="day-activity-item" *ngFor="let activity of selectedDay.activities; let i = index"
                            [ngClass]="'status-' + activity.status">

                            <div class="activity-time-badge">
                                <icon name="clock-outline" pack="eva"></icon>
                                {{ getTimeFromDate(activity.scheduledDate) }}
                            </div>

                            <div class="activity-content">
                                <h4>{{ activity.title }}</h4>
                                <p class="activity-description" *ngIf="activity.description">
                                    {{ activity.description }}
                                </p>

                                <div class="activity-meta">
                                    <!-- Cliente -->
                                    <span class="meta-item" *ngIf="activity.leadName">
                                        <icon name="person-outline" pack="eva"></icon>
                                        {{ activity.leadName }}
                                    </span>

                                    <!-- Tipo -->
                                    <span class="meta-item" *ngIf="activity.type">
                                        <icon [name]="getTypeIcon(activity.type)" pack="eva"></icon>
                                        {{ getTypeLabel(activity.type) }}
                                    </span>

                                    <!-- Status -->
                                    <span class="meta-item status-badge" [ngClass]="'status-' + activity.status">
                                        {{ getStatusLabel(activity.status) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </ng-container>

                    <!-- Mensagem quando n√£o h√° atividades -->
                    <div class="empty-day"
                        *ngIf="!selectedDay || !selectedDay.activities || selectedDay.activities.length === 0">
                        <icon name="calendar-outline" pack="eva"></icon>
                        <p>Nenhuma atividade agendada para este dia</p>
                    </div>
                </div>
            </div>

            <!-- Rodap√© do modal -->
            <div class="modal-footer">
                <div class="footer-info">
                    <span class="total-activities">
                        <icon name="list-outline" pack="eva"></icon>
                        Total: {{ selectedDay?.activities?.length || 0 }} atividade{{
                        selectedDay?.activities?.length !== 1 ? 's' : '' }}
                    </span>
                </div>
                <button class="btn btn-primary" (click)="openCreateModalForDay(selectedDay)">
                    <icon name="plus-outline" pack="eva"></icon>
                    Nova Atividade para este Dia
                </button>
            </div>
        </div>
    </div>
</div>
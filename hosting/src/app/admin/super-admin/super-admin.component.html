<!-- Arquivo: super-admin.component.html -->
<!-- Localiza√ß√£o: src/app/main/super-admin/super-admin.component.html -->

<div class="super-admin-container">
    <div class="content-wrapper">
        <!-- Header com logout -->
        <div class="admin-header">
            <h1>üè¢ Painel Super Admin</h1>
            <button class="btn-logout" (click)="logout()" title="Sair do sistema">
                üö™ Logout
            </button>
        </div>

        <!-- Mensagens -->
        <div *ngIf="mensagem" class="alert" [ngClass]="tipoMensagem">
            {{ mensagem }}
        </div>

        <!-- Card de Sucesso -->
        <div *ngIf="dadosAcesso.mostrar" class="success-card">
            <h2>‚úÖ Inst√¢ncia Criada!</h2>

            <p><strong>üåê URL de Acesso:</strong></p>
            <div class="url-box">
                <input type="text" [value]="dadosAcesso.url" readonly>
                <button (click)="copiarUrl(dadosAcesso.url)">üìã Copiar</button>
            </div>

            <div class="login-info">
                <h3>üìù Dados de Acesso:</h3>
                <div class="login-details">
                    <p><strong>Usu√°rio:</strong> matrixadmin</p>
                    <p><strong>Senha:</strong> 21211212</p>
                </div>
            </div>

            <p class="info">
                ‚ÑπÔ∏è O sistema criou automaticamente um usu√°rio administrador com senha padr√£o.
                O cliente deve alterar a senha no primeiro acesso.
            </p>

            <div class="actions">
                <button (click)="copiarDadosAcesso()" class="btn-copy-all">üìã Copiar Dados de Acesso</button>
                <button (click)="voltarParaLista()" class="btn-back">üîô Voltar para Lista</button>
                <button (click)="criarNovaInstancia()" class="btn-new">‚ûï Criar Nova</button>
            </div>

            <div class="access-warning">
                ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Anote os dados de acesso antes de sair desta tela!
            </div>
        </div>

        <!-- Lista de Inst√¢ncias Ativas -->
        <div class="instances-list" *ngIf="!dadosAcesso.mostrar && !mostrarFormulario">
            <div class="list-header">
                <h2>üìã Inst√¢ncias Ativas</h2>
                <div class="header-actions">
                    <div class="instance-stats" *ngIf="!carregandoInstancias">
                        <span class="stat-badge stat-total">
                            üìä Total: {{ instancias.length }}
                        </span>
                        <span class="stat-badge stat-active">
                            ‚úÖ Ativas: {{ contadorAtivas }}
                        </span>
                        <span class="stat-badge stat-inactive">
                            ‚ùå Inativas: {{ contadorInativas }}
                        </span>
                    </div>
                    <button class="btn-export" (click)="exportarLista()"
                        [disabled]="carregandoInstancias || instancias.length === 0">
                        üì• Exportar Lista
                    </button>
                    <button class="btn-refresh" (click)="buscarInstancias()" [disabled]="carregandoInstancias">
                        üîÑ Atualizar
                    </button>
                    <button class="btn-create" (click)="abrirFormulario()">
                        ‚ûï Nova Inst√¢ncia
                    </button>
                </div>
                <!-- Bot√£o de Debug (TEMPOR√ÅRIO - REMOVER DEPOIS) -->
                <button class="btn-refresh" (click)="verificarCRM()" style="background: #ff6b6b;">
                    üîç Debug CRM
                </button>
                <!-- Bot√£o Limpar Cache (TEMPOR√ÅRIO - REMOVER DEPOIS) -->
                <button class="btn-refresh" (click)="limparCacheCompleto()" style="background: #22c55e;">
                    üßπ Limpar Cache
                </button>
            </div>

            <!-- Barra de Busca e Filtros -->
            <div class="search-and-filters" *ngIf="!carregandoInstancias && instancias.length > 0">
                <div class="search-bar">
                    <input type="text" placeholder="üîç Buscar por empresa, projeto ou CNPJ..."
                        [(ngModel)]="filtroInstancias" (input)="filtrarInstancias()">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn" [class.active]="filtroStatus === 'todos'"
                        (click)="filtrarPorStatus('todos')">
                        Todos ({{ instancias.length }})
                    </button>
                    <button class="filter-btn" [class.active]="filtroStatus === 'ativas'"
                        (click)="filtrarPorStatus('ativas')">
                        Ativas ({{ contadorAtivas }})
                    </button>
                    <button class="filter-btn" [class.active]="filtroStatus === 'inativas'"
                        (click)="filtrarPorStatus('inativas')">
                        Inativas ({{ contadorInativas }})
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div *ngIf="carregandoInstancias" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
            </div>

            <!-- Tabela de Inst√¢ncias -->
            <div *ngIf="!carregandoInstancias && instanciasFiltradas.length > 0" class="table-wrapper">
                <table class="instances-table">
                    <thead>
                        <tr>
                            <th>Empresa</th>
                            <th>Project ID</th>
                            <th>Tipo</th>
                            <th>Configura√ß√µes</th>
                            <th>Status</th>
                            <th>Criado em</th>
                            <th>CRM</th>
                            <th>Ativo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let instancia of instanciasFiltradas">
                            <td>{{ instancia.companyName }}</td>
                            <td>
                                <code>{{ instancia.projectId }}</code>
                            </td>
                            <td>
                                <span class="badge" [ngClass]="getBadgeClass(instancia.profile?.name)">
                                    {{ getTipoDescricao(instancia.profile?.name) }}
                                </span>
                            </td>
                            <td>
                                <div class="config-badges">
                                    <!-- Moeda -->
                                    <span class="config-badge currency"
                                        [title]="'Moeda: ' + getMoedaLabel(instancia.currency)">
                                        {{ getMoedaSimbolo(instancia.currency) }}
                                    </span>

                                    <!-- Idioma -->
                                    <span class="config-badge language"
                                        [title]="'Idioma: ' + getIdiomaLabel(instancia.language)">
                                        {{ getIdiomaFlag(instancia.language) }}
                                    </span>

                                    <!-- CRM -->
                                    <span class="config-badge crm" *ngIf="instancia.hasCRM" title="CRM Ativo">
                                        üöÄ CRM
                                    </span>

                                    <!-- Fiscal -->
                                    <span class="config-badge fiscal"
                                        *ngIf="instancia.profile?.fiscal?.active || instancia.profile?.name?.includes('Fiscal')"
                                        title="Fiscal Ativo">
                                        üìã NFe
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge"
                                    [ngClass]="instancia.isPaid === false ? 'status-inactive' : 'status-active'">
                                    {{ instancia.isPaid === false ? '‚ùå Inativa' : '‚úÖ Ativa' }}
                                </span>
                            </td>
                            <td class="date-cell">
                                {{ formatarData(instancia.createdAt) }}
                            </td>
                            <td>
                                <div class="switch-container">
                                    <label class="switch switch-crm"
                                        [title]="instancia.hasCRM ? 'CRM Ativo' : 'CRM Inativo'">
                                        <input type="checkbox" [checked]="instancia.hasCRM"
                                            (change)="alternarCRM(instancia)" [disabled]="alterandoStatus">
                                        <span class="slider round" [class.crm-active]="instancia.hasCRM"></span>
                                    </label>
                                    <small class="switch-label">CRM</small>
                                </div>
                            </td>
                            <td>
                                <div class="switch-container">
                                    <label class="switch">
                                        <input type="checkbox" [checked]="instancia.isPaid !== false"
                                            (change)="alternarStatusInstancia(instancia)" [disabled]="alterandoStatus">
                                        <span class="slider round"></span>
                                    </label>
                                    <small class="switch-label">Ativo</small>
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <button class="btn-action" (click)="mostrarInfoAcesso(instancia)">
                                        üîó Ver Acesso
                                    </button>
                                    <button class="btn-action btn-edit" (click)="editarInstancia(instancia)">
                                        ‚úèÔ∏è Editar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mensagem quando n√£o h√° inst√¢ncias -->
            <div *ngIf="!carregandoInstancias && instancias.length === 0" class="no-instances">
                <p>üòï Nenhuma inst√¢ncia encontrada.</p>
                <button class="btn-create" (click)="abrirFormulario()">
                    ‚ûï Criar Primeira Inst√¢ncia
                </button>
            </div>

            <!-- Mensagem quando o filtro n√£o retorna resultados -->
            <div *ngIf="!carregandoInstancias && instancias.length > 0 && instanciasFiltradas.length === 0"
                class="no-instances">
                <p>üîç Nenhuma inst√¢ncia encontrada com o filtro "{{ filtroInstancias }}"</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Formul√°rio em Tela Cheia -->
<div class="form-modal" *ngIf="mostrarFormulario">
    <div class="modal-content">
        <div class="modal-header">
            <h2>{{ editandoInstancia ? '‚úèÔ∏è Editar Inst√¢ncia' : '‚ûï Criar Nova Inst√¢ncia' }}</h2>
            <button class="btn-close" (click)="fecharFormulario()">‚úñ</button>
        </div>

        <div class="modal-body">
            <!-- Sele√ß√£o do Tipo de M√≥dulo -->
            <div class="module-selector">
                <h3>Selecione o Tipo de M√≥dulo:</h3>
                <div class="module-options">
                    <label class="module-option" *ngFor="let modulo of modulosDisponiveis"
                        [class.active]="tipoModulo === modulo.id">
                        <input type="radio" name="tipoModulo" [value]="modulo.id" [(ngModel)]="tipoModulo"
                            (change)="mudarTipoModulo(modulo.id)">
                        <div class="module-card">
                            <span class="icon">{{ modulo.icone }}</span>
                            <span class="title">{{ modulo.nome }}</span>
                            <span class="desc">{{ modulo.descricao }}</span>
                        </div>
                    </label>
                </div>

                <!-- Checkbox para incluir m√≥dulo fiscal -->
                <div class="fiscal-option">
                    <label class="fiscal-checkbox">
                        <input type="checkbox" [(ngModel)]="incluiFiscal" name="incluiFiscal">
                        <span>Incluir m√≥dulo Fiscal (NFe, NFCe, etc.)</span>
                    </label>
                </div>

                <!-- Checkbox para incluir m√≥dulo CRM -->
                <div class="fiscal-option">
                    <label class="fiscal-checkbox">
                        <input type="checkbox" [(ngModel)]="incluiCRM" name="incluiCRM">
                        <span>üöÄ Incluir m√≥dulo CRM (Gest√£o de Relacionamento)</span>
                    </label>
                    <small style="display: block; margin-left: 30px; color: #666; margin-top: 5px;">
                        M√≥dulo vendido separadamente - Leads, Pipeline, Atividades
                    </small>
                </div>
            </div>

            <form (ngSubmit)="criarInstancia()">
                <div class="form-grid">
                    <!-- Dados B√°sicos -->
                    <div class="form-section">
                        <h3>Informa√ß√µes da Empresa</h3>

                        <div class="form-group">
                            <label>Nome da Empresa: *</label>
                            <input type="text" [(ngModel)]="novaInstancia.companyName" name="companyName"
                                (blur)="gerarProjectId()" required>
                        </div>

                        <div class="form-group">
                            <label>ID do Projeto:</label>
                            <input type="text" [(ngModel)]="novaInstancia.projectId" name="projectId"
                                [readonly]="editandoInstancia">
                        </div>

                        <div class="form-group">
                            <label>CNPJ: *</label>
                            <input type="text" [(ngModel)]="novaInstancia.stores[0].cnpj" name="cnpj" required>
                        </div>

                        <!-- Campos de Configura√ß√£o Regional -->
                        <div class="form-group">
                            <label>Moeda: *</label>
                            <select [(ngModel)]="novaInstancia.currency" name="currency" required>
                                <option value="BRL">üíµ Real Brasileiro (R$)</option>
                                <option value="USD">üíµ D√≥lar Americano ($)</option>
                                <option value="EUR">üí∂ Euro (‚Ç¨)</option>
                                <option value="GBP">üí∑ Libra Esterlina (¬£)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Idioma: *</label>
                            <select [(ngModel)]="novaInstancia.language" name="language" required>
                                <option value="pt_BR">üáßüá∑ Portugu√™s (Brasil)</option>
                                <option value="en_US">üá∫üá∏ Ingl√™s (EUA)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Contatos -->
                    <div class="form-section">
                        <h3>Contatos</h3>

                        <div class="form-group">
                            <label>Email: *</label>
                            <input type="email" [(ngModel)]="novaInstancia.stores[0].contacts.email" name="email"
                                required>
                        </div>

                        <div class="form-group">
                            <label>WhatsApp:</label>
                            <input type="text" [(ngModel)]="novaInstancia.stores[0].contacts.whatsapp" name="whatsapp">
                        </div>

                        <div class="form-group">
                            <label>Telefone:</label>
                            <input type="text" [(ngModel)]="novaInstancia.stores[0].contacts.phone" name="phone">
                        </div>
                    </div>

                    <!-- Endere√ßo -->
                    <div class="form-section">
                        <h3>Endere√ßo</h3>

                        <div class="form-group">
                            <label>CEP:</label>
                            <input type="text" [(ngModel)]="novaInstancia.stores[0].address.postalCode"
                                name="postalCode">
                        </div>

                        <div class="form-group">
                            <label>Cidade:</label>
                            <input type="text" [(ngModel)]="novaInstancia.stores[0].address.city" name="city">
                        </div>

                        <div class="form-group">
                            <label>Estado:</label>
                            <select [(ngModel)]="novaInstancia.stores[0].address.state" name="state">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label>Endere√ßo:</label>
                            <textarea [(ngModel)]="novaInstancia.stores[0].address.addressLine" name="addressLine"
                                rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes -->
                <div class="form-actions">
                    <button type="submit" class="btn-submit" [disabled]="carregando">
                        {{ carregando ? (editandoInstancia ? 'Atualizando...' : 'Criando...') : (editandoInstancia ?
                        'Atualizar Inst√¢ncia' : 'Criar Inst√¢ncia') }}
                    </button>
                    <button type="button" class="btn-cancel" (click)="fecharFormulario()">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loader igual ao do login -->
<div id="mainLoadingTaskAuth" class="loadingTask">
    <div class="d-flex w-100 h-100 flex-column justify-content-center align-items-center">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Modal de Informa√ß√µes de Acesso -->
<div class="access-modal" *ngIf="mostrarModalAcesso" (click)="fecharModalAcesso()">
    <div class="access-modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>üîó Informa√ß√µes de Acesso</h3>
            <button class="btn-close" (click)="fecharModalAcesso()">‚úñ</button>
        </div>

        <div class="modal-body">
            <div class="info-section">
                <h4>{{ instanciaSelecionada?.companyName }}</h4>
                <p class="project-id">Project ID: <code>{{ instanciaSelecionada?.projectId }}</code></p>
            </div>

            <div class="url-section">
                <label>URL de Acesso:</label>
                <div class="url-box">
                    <input type="text" [value]="urlInstanciaSelecionada" readonly>
                    <button (click)="copiarUrl(urlInstanciaSelecionada)">üìã Copiar</button>
                </div>
            </div>

            <div class="login-info-box">
                <p><strong>‚ö†Ô∏è Importante:</strong> O cliente precisa ter login e senha para acessar.</p>
                <p>Login padr√£o para novas inst√¢ncias:</p>
                <ul>
                    <li>Usu√°rio: <code>matrixadmin</code></li>
                    <li>Senha: <code>21211212</code></li>
                </ul>
            </div>

            <div class="actions">
                <button class="btn-copy-info" (click)="copiarInfoCompleta()">üìã Copiar Todas as Informa√ß√µes</button>
                <a [href]="urlInstanciaSelecionada" target="_blank" class="btn-access">üöÄ Abrir em Nova Aba</a>
            </div>
        </div>
    </div>
</div>